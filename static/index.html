<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ì»¤ë®¤ë‹ˆí‹°</title>
    <!-- í°íŠ¸: ê¹”ë”í•œ Noto Sans KR -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- ê¸°ë³¸ ë””ìì¸ (ìŠ¤í¬ë¦°ìƒ· ìŠ¤íƒ€ì¼) --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8f9fa; color: #333; line-height: 1.6; }
        a { text-decoration: none; color: inherit; }
        ul { list-style: none; }

        /* í—¤ë” */
        header {
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #007bff; /* íŒŒë€ìƒ‰ ë¡œê³  */
            cursor: pointer;
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ & í”„ë¡œí•„ ì˜ì—­ */
        .nav-buttons { display: flex; align-items: center; }
        .nav-buttons button {
            margin-left: 10px;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .btn-login { background-color: #007bff; color: white; }
        .btn-login:hover { background-color: #0056b3; }
        .btn-logout { background-color: #e9ecef; color: #495057; }
        .btn-logout:hover { background-color: #dee2e6; }

        /* [ê¸°ëŠ¥ ì¶”ê°€] í”„ë¡œí•„ ì´ë¯¸ì§€ ë° ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
        .profile-container { position: relative; margin-left: 15px; cursor: pointer; }
        .profile-img-header {
            width: 40px; height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #ddd;
            transition: border-color 0.2s;
        }
        .profile-img-header:hover { border-color: #007bff; }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 50px; right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 180px;
            overflow: hidden;
            border: 1px solid #eee;
            flex-direction: column;
            z-index: 200;
        }
        .dropdown-menu.show { display: flex; }
        .dropdown-item {
            padding: 12px 16px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.2s;
            text-align: left;
            border: none;
            background: none;
            width: 100%;
            display: block;
            color: #333;
        }
        .dropdown-item:hover { background-color: #f8f9fa; color: #007bff; }
        .dropdown-divider { border-top: 1px solid #eee; margin: 0; }

        /* ë©”ì¸ ì»¨í…ì¸  */
        main { max-width: 800px; margin: 2rem auto; padding: 0 1rem; }

        /* ê¸€ì“°ê¸° ë²„íŠ¼ (ì´ˆë¡ìƒ‰) */
        .action-bar { display: flex; justify-content: flex-end; margin-bottom: 1.5rem; }
        .btn-write {
            background-color: #28a745; /* ì´ˆë¡ìƒ‰ ë²„íŠ¼ */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(40, 167, 69, 0.2);
            transition: transform 0.2s;
        }
        .btn-write:hover {
            transform: translateY(-2px);
            background-color: #218838;
        }

        /* ê²Œì‹œê¸€ ì¹´ë“œ */
        .post-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            transition: box-shadow 0.2s;
            cursor: pointer;
        }
        .post-card:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .post-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem; }
        .post-content { color: #666; font-size: 0.95rem; margin-bottom: 1rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .post-meta { display: flex; gap: 15px; color: #adb5bd; font-size: 0.85rem; align-items: center; }
        .post-author { font-weight: bold; color: #555; display: flex; align-items: center; gap: 5px; }
        .post-author-img { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; }

        /* ëª¨ë‹¬ ê³µí†µ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; position: relative; max-height: 90vh; overflow-y: auto; }
        .close-btn { position: absolute; top: 15px; right: 15px; font-size: 1.5rem; cursor: pointer; color: #aaa; }
        .form-input, .form-textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; margin-bottom: 1rem; }
        .form-textarea { height: 150px; resize: none; }
        .btn-submit { width: 100%; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; }

        /* [ê¸°ëŠ¥ ì¶”ê°€] í”„ë¡œí•„ ìˆ˜ì • ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .profile-edit-header { text-align: center; margin-bottom: 2rem; }
        .profile-img-large {
            width: 100px; height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #eee;
            margin-bottom: 10px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .profile-img-large:hover { opacity: 0.8; }
        .profile-email { color: #888; font-size: 0.9rem; margin-bottom: 5px; }
        .img-upload-hint { font-size: 0.8rem; color: #aaa; }

        /* ìƒì„¸ë³´ê¸° ìŠ¤íƒ€ì¼ */
        .detail-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; }
        .detail-info { color: #888; font-size: 0.9rem; margin-bottom: 1.5rem; display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .detail-body { font-size: 1rem; line-height: 1.6; min-height: 100px; margin-bottom: 2rem; white-space: pre-wrap; }
        .detail-actions { display: flex; gap: 10px; margin-bottom: 2rem; justify-content: center; }
        .btn-like { background: #ff4757; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 5px; }

        /* ëŒ“ê¸€ ìŠ¤íƒ€ì¼ */
        .comment-section { background: #f8f9fa; padding: 1rem; border-radius: 8px; }
        .comment-header-text { font-weight: bold; margin-bottom: 10px; color: #555; }
        .comment-input-box { display: flex; gap: 10px; margin-bottom: 1rem; }
        .comment-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .btn-comment { background: #333; color: white; border: none; padding: 0 15px; border-radius: 4px; cursor: pointer; }
        .comment-list { display: flex; flex-direction: column; gap: 10px; }

        /* ëŒ“ê¸€ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .comment-item { background: white; padding: 12px; border-radius: 8px; border: 1px solid #eee; }
        .comment-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.85rem; }
        .comment-author { font-weight: 700; color: #333; }
        .comment-date { color: #aaa; margin-left: 8px; }
        .comment-body { color: #555; font-size: 0.95rem; }
        .btn-del-comment { color: #dc3545; cursor: pointer; font-size: 0.8rem; }

        /* AI íˆ´ë°” */
        .ai-toolbar { background: #f1f8ff; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: flex; gap: 10px; align-items: center; }
        .ai-select { padding: 5px; border-radius: 4px; border: 1px solid #ccc; }
        .btn-ai { background: #6f42c1; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

    <!-- í—¤ë” -->
    <header>
        <div class="logo" onclick="location.reload()">ğŸš€ AI Community</div>
        <div class="nav-buttons" id="navButtons">
            <!-- ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ JSë¡œ ì±„ì›Œì§ -->
        </div>
    </header>

    <!-- ë©”ì¸ -->
    <main>
        <div class="action-bar">
            <button class="btn-write" onclick="openWriteModal()">âœï¸ ìƒˆ ê¸€ ì“°ê¸°</button>
        </div>
        <div id="postList">
            <div style="text-align:center; padding: 2rem; color:#888;">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
    </main>

    <!-- 1. ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="loginModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('loginModal')">&times;</span>
            <h2 style="text-align:center; margin-bottom:20px;">ë¡œê·¸ì¸</h2>
            <input type="email" id="loginEmail" class="form-input" placeholder="ì´ë©”ì¼">
            <input type="password" id="loginPassword" class="form-input" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <button class="btn-submit" onclick="login()">ë¡œê·¸ì¸í•˜ê¸°</button>
        </div>
    </div>

    <!-- 2. íšŒì›ê°€ì… ëª¨ë‹¬ -->
    <div id="signupModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('signupModal')">&times;</span>
            <h2 style="text-align:center; margin-bottom:20px;">íšŒì›ê°€ì…</h2>
            <input type="email" id="signupEmail" class="form-input" placeholder="ì´ë©”ì¼">
            <input type="text" id="signupNickname" class="form-input" placeholder="ë‹‰ë„¤ì„">
            <input type="password" id="signupPassword" class="form-input" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <input type="password" id="signupConfirm" class="form-input" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
            <button class="btn-submit" onclick="signup()">ê°€ì…í•˜ê¸°</button>
        </div>
    </div>

    <!-- 3. íšŒì›ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ (í”„ë¡œí•„ ì´ë¯¸ì§€ í¬í•¨) -->
    <div id="profileModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('profileModal')">&times;</span>
            <div class="profile-edit-header">
                <!-- ì´ë¯¸ì§€ í´ë¦­ ì‹œ íŒŒì¼ ì—…ë¡œë“œ íŠ¸ë¦¬ê±° (í˜„ì¬ëŠ” ë¯¸ë¦¬ë³´ê¸°ë§Œ êµ¬í˜„) -->
                <img src="https://via.placeholder.com/100" id="profileImgPreview" class="profile-img-large" onclick="document.getElementById('profileImgInput').click()">
                <input type="file" id="profileImgInput" style="display:none;" accept="image/*" onchange="previewImage(this)">
                <div class="img-upload-hint">ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ì—¬ ë³€ê²½</div>
                <div id="displayEmail" class="profile-email">user@example.com</div>
            </div>

            <label style="font-weight:bold;">ë‹‰ë„¤ì„</label>
            <input type="text" id="editNickname" class="form-input" placeholder="ë‹‰ë„¤ì„">
            <button class="btn-submit" onclick="updateProfile()">ì •ë³´ ìˆ˜ì • ì™„ë£Œ</button>
        </div>
    </div>

    <!-- 4. ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ -->
    <div id="passwordModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('passwordModal')">&times;</span>
            <h2 style="text-align:center; margin-bottom:20px;">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h2>
            <input type="password" id="newPassword" class="form-input" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸">
            <input type="password" id="confirmPassword" class="form-input" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
            <button class="btn-submit" onclick="updatePassword()">ë³€ê²½í•˜ê¸°</button>
        </div>
    </div>

    <!-- 5. ê¸€ì“°ê¸° ëª¨ë‹¬ -->
    <div id="writeModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('writeModal')">&times;</span>
            <h2 style="text-align:center; margin-bottom:15px;">ê²Œì‹œê¸€ ì‘ì„±</h2>
            <input type="text" id="postTitle" class="form-input" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">

            <div class="ai-toolbar">
                <span>ğŸ¤– AI í†¤ ë³€í™˜:</span>
                <select id="toneSelect" class="ai-select">
                    <option value="ì‚¬ê·¹">ì‚¬ê·¹</option>
                    <option value="ì¤‘2ë³‘">ì¤‘2ë³‘</option>
                    <option value="ì „ë¼ë„ ì‚¬íˆ¬ë¦¬">ì „ë¼ë„ ì‚¬íˆ¬ë¦¬</option>
                    <option value="ìœ ì¹˜ì›ìƒ">ìœ ì¹˜ì›ìƒ</option>
                </select>
                <button class="btn-ai" onclick="convertAI()">ë³€í™˜ ì ìš©</button>
            </div>

            <textarea id="postContent" class="form-textarea" placeholder="ë‚´ìš©ì„ ììœ ë¡­ê²Œ ì‘ì„±í•˜ì„¸ìš”"></textarea>
            <button class="btn-submit" onclick="createPost()">ë“±ë¡í•˜ê¸°</button>
        </div>
    </div>

    <!-- 6. ìƒì„¸ ëª¨ë‹¬ -->
    <div id="detailModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('detailModal')">&times;</span>

            <h2 id="dTitle" class="detail-title">ì œëª©</h2>
            <div class="detail-info">
                <span id="dAuthor" style="font-weight:bold; margin-right:10px;">ì‘ì„±ì</span>
                <span id="dDate">ë‚ ì§œ</span>
                <span id="dViews" style="margin-left:10px;">ì¡°íšŒìˆ˜ 0</span>
            </div>
            <div id="dContent" class="detail-body">ë‚´ìš©</div>

            <div class="detail-actions">
                <button class="btn-like" onclick="toggleLike()">
                    â¤ï¸ ì¢‹ì•„ìš” <span id="dLikes">0</span>
                </button>
                <button class="btn-logout" id="btnDeletePost" style="display:none;" onclick="deletePost()">ì‚­ì œ</button>
            </div>

            <div class="comment-section">
                <div class="comment-header-text">ëŒ“ê¸€</div>
                <div class="comment-input-box">
                    <input type="text" id="commentInput" class="comment-input" placeholder="ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”">
                    <button class="btn-comment" onclick="addComment()">ë“±ë¡</button>
                </div>
                <div id="commentList" class="comment-list"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "http://localhost:8000";
        const DEFAULT_PROFILE_IMG = "https://via.placeholder.com/40";

        let userToken = localStorage.getItem("access_token");
        let userId = localStorage.getItem("user_id");
        let userEmail = localStorage.getItem("user_email");
        let userNickname = localStorage.getItem("user_nickname");
        let currentPostId = null;

        document.addEventListener("DOMContentLoaded", () => {
            updateNav();
            loadPosts();

            // ë“œë¡­ë‹¤ìš´ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            document.addEventListener('click', function(event) {
                const profileContainer = document.querySelector('.profile-container');
                const dropdown = document.querySelector('.dropdown-menu');
                if (dropdown && profileContainer && !profileContainer.contains(event.target)) {
                    dropdown.classList.remove('show');
                }
            });
        });

        // --- ê³µí†µ UI ---
        function updateNav() {
            const nav = document.getElementById("navButtons");
            if (userToken) {
                nav.innerHTML = `
                    <div class="profile-container" onclick="toggleDropdown()">
                        <img src="${DEFAULT_PROFILE_IMG}" class="profile-img-header" alt="Profile">
                        <div class="dropdown-menu" id="profileDropdown">
                            <div style="padding:12px 16px; color:#999; font-size:0.8rem;">${userEmail || 'ë¡œê·¸ì¸ ê³„ì •'}</div>
                            <hr class="dropdown-divider">
                            <button class="dropdown-item" onclick="openProfileModal()">íšŒì›ì •ë³´ ìˆ˜ì •</button>
                            <button class="dropdown-item" onclick="openModal('passwordModal')">ë¹„ë°€ë²ˆí˜¸ ìˆ˜ì •</button>
                            <hr class="dropdown-divider">
                            <button class="dropdown-item" style="color:red;" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                        </div>
                    </div>
                `;
            } else {
                nav.innerHTML = `
                    <button class="btn-login" onclick="openModal('loginModal')">ë¡œê·¸ì¸</button>
                    <button class="btn-logout" onclick="openModal('signupModal')">íšŒì›ê°€ì…</button>
                `;
            }
        }

        function toggleDropdown() {
            const dropdown = document.getElementById("profileDropdown");
            dropdown.classList.toggle("show");
        }

        function openModal(id) {
            document.querySelectorAll('.modal-overlay').forEach(m => m.style.display='none');
            document.getElementById(id).style.display = 'flex';
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function openProfileModal() {
            document.getElementById("displayEmail").innerText = userEmail || "ì´ë©”ì¼ ì •ë³´ ì—†ìŒ";
            document.getElementById("editNickname").value = userNickname || "";
            document.getElementById("profileImgPreview").src = DEFAULT_PROFILE_IMG;
            openModal('profileModal');
        }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profileImgPreview').src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- 1. ëª©ë¡ ì¡°íšŒ ---
        async function loadPosts() {
            try {
                const res = await fetch(`${API_BASE}/posts`);
                const data = await res.json();
                const posts = data.posts || data;

                const list = document.getElementById("postList");
                if(posts.length === 0) {
                    list.innerHTML = "<div style='text-align:center; padding:2rem;'>ì‘ì„±ëœ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
                    return;
                }

                list.innerHTML = posts.map(p => `
                    <div class="post-card" onclick="openDetail(${p.id})">
                        <div class="post-title">${escapeHtml(p.title)}</div>
                        <div class="post-content">${escapeHtml(p.content)}</div>
                        <div class="post-meta">
                            <div class="post-author">
                                <img src="${DEFAULT_PROFILE_IMG}" class="post-author-img">
                                <span>${p.author_nickname || 'ìµëª…'}</span>
                            </div>
                            <span>ğŸ‘€ ${p.views}</span>
                            <span>â¤ï¸ ${p.likes}</span>
                            <span>ğŸ’¬ ${p.comments_count || 0}</span>
                            <span>ğŸ“… ${new Date(p.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                `).join('');
            } catch(e) { console.error(e); }
        }

        // --- 2. ìƒì„¸ë³´ê¸° ---
        async function openDetail(id) {
            currentPostId = id;
            try {
                const res = await fetch(`${API_BASE}/posts/${id}`);
                if(!res.ok) throw new Error("ë¡œë“œ ì‹¤íŒ¨");
                const post = await res.json();

                document.getElementById("dTitle").innerText = post.title;
                document.getElementById("dContent").innerText = post.content;
                document.getElementById("dAuthor").innerText = `ğŸ‘¤ ${post.author_nickname || 'ìµëª…'}`;
                document.getElementById("dDate").innerText = new Date(post.created_at).toLocaleString();
                document.getElementById("dViews").innerText = `ì¡°íšŒìˆ˜ ${post.views}`;
                document.getElementById("dLikes").innerText = post.likes;

                const delBtn = document.getElementById("btnDeletePost");
                if (userToken && post.author_id == userId) delBtn.style.display = 'block';
                else delBtn.style.display = 'none';

                loadComments(id);
                openModal("detailModal");
            } catch(e) { alert("ê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); }
        }

        // --- 3. ì¢‹ì•„ìš” ---
        async function toggleLike() {
            if(!userToken) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            try {
                const res = await fetch(`${API_BASE}/posts/${currentPostId}/like`, {
                    method: "POST", headers: { "Authorization": `Bearer ${userToken}` }
                });
                if(res.ok) {
                    const data = await res.json();
                    document.getElementById("dLikes").innerText = data.likes;
                    loadPosts();
                }
            } catch(e) {}
        }

        // --- 4. ê²Œì‹œê¸€ ì‚­ì œ ---
        async function deletePost() {
            if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            try {
                const res = await fetch(`${API_BASE}/posts/${currentPostId}`, {
                    method: "DELETE", headers: { "Authorization": `Bearer ${userToken}` }
                });
                if(res.ok) {
                    alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    closeModal("detailModal");
                    loadPosts();
                } else {
                    alert("ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
                }
            } catch(e) {}
        }

        // --- 5. ëŒ“ê¸€ ê´€ë ¨ ---
        async function loadComments(postId) {
            try {
                const res = await fetch(`${API_BASE}/comments/${postId}`);
                const comments = await res.json();
                const list = document.getElementById("commentList");

                if (comments.length === 0) {
                    list.innerHTML = "<div style='color:#aaa; text-align:center; padding:10px;'>ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</div>";
                    return;
                }

                list.innerHTML = comments.map(c => `
                    <div class="comment-item">
                        <div class="comment-header">
                            <div>
                                <span class="comment-author">ğŸ‘¤ ${c.author_nickname || 'ìµëª…'}</span>
                                <span class="comment-date">${new Date(c.created_at).toLocaleString()}</span>
                            </div>
                            ${userToken ? `<span class="btn-del-comment" onclick="deleteComment(${c.id})">ì‚­ì œ</span>` : ''}
                        </div>
                        <div class="comment-body">${escapeHtml(c.content)}</div>
                    </div>
                `).join('');
            } catch(e) {}
        }

        async function addComment() {
            if(!userToken) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            const content = document.getElementById("commentInput").value;
            if(!content) return;

            try {
                const res = await fetch(`${API_BASE}/comments/${currentPostId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${userToken}` },
                    body: JSON.stringify({ content })
                });
                if(res.ok) {
                    document.getElementById("commentInput").value = "";
                    loadComments(currentPostId);
                    loadPosts();
                }
            } catch(e) { alert("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨"); }
        }

        async function deleteComment(cid) {
            if(!confirm("ëŒ“ê¸€ì„ ì‚­ì œí• ê¹Œìš”?")) return;
            try {
                const res = await fetch(`${API_BASE}/comments/${cid}`, {
                    method: "DELETE", headers: { "Authorization": `Bearer ${userToken}` }
                });
                if(res.ok) loadComments(currentPostId);
                else alert("ë³¸ì¸ ëŒ“ê¸€ë§Œ ì‚­ì œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            } catch(e) {}
        }

        // --- 6. ê¸€ì“°ê¸° ---
        function openWriteModal() {
            if(!userToken) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.");
            openModal("writeModal");
        }

        async function createPost() {
            const title = document.getElementById("postTitle").value;
            const content = document.getElementById("postContent").value;

            try {
                const res = await fetch(`${API_BASE}/posts`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${userToken}` },
                    body: JSON.stringify({ title, content })
                });
                if(res.ok) {
                    alert("ê²Œì‹œê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    closeModal("writeModal");
                    document.getElementById("postTitle").value = "";
                    document.getElementById("postContent").value = "";
                    loadPosts();
                } else throw new Error();
            } catch(e) { alert("ê²Œì‹œê¸€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
        }

        // --- 7. AI ë³€í™˜ ---
        async function convertAI() {
            const text = document.getElementById("postContent").value;
            const tone = document.getElementById("toneSelect").value;
            if(!text) return alert("ë³€í™˜í•  ë‚´ìš©ì„ ë¨¼ì € ì‘ì„±í•´ì£¼ì„¸ìš”!");

            const btn = document.querySelector(".btn-ai");
            const oldText = btn.innerText;
            btn.innerText = "ë³€í™˜ ì¤‘...";
            btn.disabled = true;

            try {
                const res = await fetch(`${API_BASE}/ai_tone/convert`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ text, tone })
                });
                const data = await res.json();
                if(data.converted_text) document.getElementById("postContent").value = data.converted_text;
            } catch(e) { alert("AI ë³€í™˜ ì‹¤íŒ¨"); }
            finally { btn.innerText = oldText; btn.disabled = false; }
        }

        // --- 8. íšŒì›ì •ë³´ ê´€ë¦¬ ---
        async function updateProfile() {
            const nickname = document.getElementById("editNickname").value;
            if(!nickname) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            if (!userId) {
                alert("ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/users/${userId}/profile`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${userToken}` },
                    body: JSON.stringify({ nickname })
                });

                if(res.ok) {
                    localStorage.setItem("user_nickname", nickname);
                    userNickname = nickname;
                    alert("ë‹‰ë„¤ì„ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    closeModal("profileModal");
                    location.reload();
                } else {
                    const err = await res.json();
                    const errMsg = typeof err.detail === 'object' ? JSON.stringify(err.detail) : (err.detail || "ìˆ˜ì • ì‹¤íŒ¨");
                    alert(errMsg);
                }
            } catch(e) {
                console.error(e);
                alert("ì˜¤ë¥˜ ë°œìƒ");
            }
        }

        async function updatePassword() {
            const password = document.getElementById("newPassword").value;
            const confirm = document.getElementById("confirmPassword").value;
            if(!password) return alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            try {
                const res = await fetch(`${API_BASE}/users/${userId}/password`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${userToken}` },
                    body: JSON.stringify({ password, confirm_password: confirm })
                });
                if(res.ok) {
                    alert("ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    closeModal("passwordModal");
                } else {
                    const err = await res.json();
                    alert(err.detail || "ë³€ê²½ ì‹¤íŒ¨");
                }
            } catch(e) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
        }

        async function deleteUser() {
            if(!confirm("ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ì •ë³´ê°€ ì‚­ì œë©ë‹ˆë‹¤.")) return;
            try {
                const res = await fetch(`${API_BASE}/users/${userId}`, {
                    method: "DELETE",
                    headers: { "Authorization": `Bearer ${userToken}` }
                });
                if(res.ok) {
                    alert("íšŒì› íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    logout();
                } else alert("íƒˆí‡´ ì‹¤íŒ¨");
            } catch(e) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
        }

        // --- ê¸°íƒ€ (ë¡œê·¸ì¸/ê°€ì…) ---
        async function login() {
            const email = document.getElementById("loginEmail").value;
            const password = document.getElementById("loginPassword").value;
            try {
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email, password })
                });
                if(res.ok) {
                    const data = await res.json();

                    localStorage.setItem("access_token", data.access_token);
                    if (data.user_id) {
                        localStorage.setItem("user_id", data.user_id);
                        userId = data.user_id;
                    } else {
                        alert("ë¡œê·¸ì¸ ì‘ë‹µ ì˜¤ë¥˜: user_idê°€ ì—†ìŠµë‹ˆë‹¤.");
                        return;
                    }
                    localStorage.setItem("user_email", email);

                    userToken = data.access_token;
                    userEmail = email;

                    updateNav();
                    closeModal("loginModal");
                    alert("ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‘‹");
                } else {
                    const err = await res.json();
                    alert(err.detail || "ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
                }
            } catch(e) {
                console.error(e);
                alert("ë¡œê·¸ì¸ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        async function signup() {
            const email = document.getElementById("signupEmail").value;
            const nickname = document.getElementById("signupNickname").value;
            const password = document.getElementById("signupPassword").value;
            const confirm = document.getElementById("signupConfirm").value;
            try {
                const res = await fetch(`${API_BASE}/auth/signup`, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email, nickname, password, password_confirm: confirm })
                });
                if(res.ok) {
                    alert("ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš” ğŸ‰"); closeModal("signupModal");
                } else {
                    const err = await res.json();
                    alert(err.detail || "ê°€ì… ì‹¤íŒ¨");
                }
            } catch(e) {}
        }

        function logout() {
            localStorage.removeItem("access_token");
            localStorage.removeItem("user_id");
            localStorage.removeItem("user_email");
            localStorage.removeItem("user_nickname");
            userToken = null;
            userId = null;
            userEmail = null;
            userNickname = null;
            updateNav();
            document.querySelectorAll('.modal-overlay').forEach(m => m.style.display='none');
            alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        function escapeHtml(text) {
            return text ? text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : "";
        }
    </script>
</body>
</html>