<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ì»¤ë®¤ë‹ˆí‹°</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- ê¸°ë³¸ ë””ìì¸ --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8f9fa; color: #333; line-height: 1.6; }
        a { text-decoration: none; color: inherit; }
        ul { list-style: none; }

        /* í—¤ë” */
        header { background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 1.5rem; font-weight: 700; color: #007bff; cursor: pointer; }

        /* ë„¤ë¹„ê²Œì´ì…˜ & í”„ë¡œí•„ */
        .nav-buttons { display: flex; align-items: center; }
        .nav-buttons button { margin-left: 10px; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; }
        .btn-login { background-color: #007bff; color: white; }
        .btn-login:hover { background-color: #0056b3; }
        .btn-logout { background-color: #e9ecef; color: #495057; }
        .btn-logout:hover { background-color: #dee2e6; }
        .profile-container { position: relative; margin-left: 15px; cursor: pointer; }
        .profile-img-header { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd; transition: border-color 0.2s; }
        .profile-img-header:hover { border-color: #007bff; }

        .dropdown-menu { display: none; position: absolute; top: 50px; right: 0; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 180px; overflow: hidden; border: 1px solid #eee; flex-direction: column; z-index: 200; }
        .dropdown-menu.show { display: flex; }
        .dropdown-item { padding: 12px 16px; font-size: 0.9rem; cursor: pointer; transition: background 0.2s; text-align: left; border: none; background: none; width: 100%; display: block; color: #333; }
        .dropdown-item:hover { background-color: #f8f9fa; color: #007bff; }
        .dropdown-divider { border-top: 1px solid #eee; margin: 0; }

        /* ë©”ì¸ ì»¨í…ì¸  */
        main { max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
        .action-bar { display: flex; justify-content: flex-end; margin-bottom: 1.5rem; }

        /* [ìˆ˜ì •] ìƒˆ ê¸€ ì“°ê¸° ë²„íŠ¼: ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ì—°í•´ì§€ë„ë¡ ë³€ê²½ */
        .btn-write {
            background-color: #28a745; /* ê¸°ë³¸ ì´ˆë¡ìƒ‰ */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(40, 167, 69, 0.2);
            transition: all 0.2s;
        }
        .btn-write:hover {
            transform: translateY(-2px);
            background-color: #5bd778; /* [ë³€ê²½] ë” ì—°í•œ ì´ˆë¡ìƒ‰ */
        }

        /* ê²Œì‹œê¸€ ì¹´ë“œ */
        .post-card { background: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.03); transition: box-shadow 0.2s; cursor: pointer; }
        .post-card:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .post-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem; }
        .post-content { color: #666; font-size: 0.95rem; margin-bottom: 1rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .post-meta { display: flex; gap: 15px; color: #adb5bd; font-size: 0.85rem; align-items: center; }
        .post-author { font-weight: bold; color: #555; display: flex; align-items: center; gap: 5px; }
        .post-author-img { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; }
        .post-thumbnail { width: 100%; max-height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 10px; display: none; }

        /* í˜ì´ì§€ë„¤ì´ì…˜ */
        .pagination { display: flex; justify-content: center; gap: 10px; margin-top: 2rem; }
        .btn-page { padding: 8px 12px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; }
        .btn-page:disabled { background: #eee; cursor: not-allowed; color: #aaa; }

        /* ëª¨ë‹¬ ê³µí†µ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; position: relative; max-height: 90vh; overflow-y: auto; }
        .close-btn { position: absolute; top: 15px; right: 15px; font-size: 1.5rem; cursor: pointer; color: #aaa; }

        .form-input, .form-textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; margin-bottom: 1rem; transition: border-color 0.2s; }
        .form-input:focus, .form-textarea:focus { border-color: #007bff; outline: none; }
        .form-textarea { height: 150px; resize: none; }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-submit { width: 100%; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .btn-submit:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-submit:not(:disabled):hover { background-color: #0056b3; }

        /* [ì¶”ê°€] íšŒì›íƒˆí‡´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-delete-account {
            width: 100%;
            padding: 12px;
            background-color: white;
            color: #dc3545;
            border: 1px solid #dc3545;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s;
        }
        .btn-delete-account:hover {
            background-color: #dc3545;
            color: white;
        }

        /* ê²€ì¦ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .error-msg { color: #dc3545; font-size: 0.8rem; margin-top: -10px; margin-bottom: 10px; padding-left: 2px; display: none; line-height: 1.4; }
        .success-msg { color: #28a745; font-size: 0.8rem; margin-top: -10px; margin-bottom: 10px; padding-left: 2px; display: none; line-height: 1.4; }

        /* í”„ë¡œí•„ ìˆ˜ì • */
        .profile-edit-header { text-align: center; margin-bottom: 2rem; }
        .profile-img-large { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid #eee; margin-bottom: 10px; cursor: pointer; transition: opacity 0.2s; }
        .profile-img-large:hover { opacity: 0.8; }
        .profile-email { color: #888; font-size: 0.9rem; margin-bottom: 5px; }
        .img-upload-hint { font-size: 0.8rem; color: #aaa; }

        /* ìƒì„¸ë³´ê¸° */
        .detail-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; }
        .detail-img { width: 100%; border-radius: 8px; margin-bottom: 1rem; display: none; }
        .detail-info { color: #888; font-size: 0.9rem; margin-bottom: 1.5rem; display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .detail-body { font-size: 1rem; line-height: 1.6; min-height: 100px; margin-bottom: 2rem; white-space: pre-wrap; }
        .detail-actions { display: flex; gap: 10px; margin-bottom: 2rem; justify-content: center; }
        .btn-like { background: #ff4757; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 5px; }

        /* ëŒ“ê¸€ */
        .comment-section { background: #f8f9fa; padding: 1rem; border-radius: 8px; }
        .comment-header-text { font-weight: bold; margin-bottom: 10px; color: #555; }
        .comment-input-box { display: flex; gap: 10px; margin-bottom: 1rem; }
        .comment-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .btn-comment { background: #333; color: white; border: none; padding: 0 15px; border-radius: 4px; cursor: pointer; }
        .comment-list { display: flex; flex-direction: column; gap: 10px; }
        .comment-item { background: white; padding: 12px; border-radius: 8px; border: 1px solid #eee; }
        .comment-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.85rem; }
        .comment-author { font-weight: 700; color: #333; }
        .comment-date { color: #aaa; margin-left: 8px; }
        .btn-del-comment { color: #dc3545; cursor: pointer; font-size: 0.8rem; }

        /* AI íˆ´ë°” */
        .ai-toolbar { background: #f1f8ff; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: flex; gap: 10px; align-items: center; }
        .ai-select { padding: 5px; border-radius: 4px; border: 1px solid #ccc; }
        .btn-ai { background: #6f42c1; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

    <header>
        <div class="logo" onclick="location.reload()">ğŸš€ AI Community</div>
        <div class="nav-buttons" id="navButtons"></div>
    </header>

    <main>
        <div class="action-bar">
            <button class="btn-write" onclick="openWriteModal()">âœï¸ ìƒˆ ê¸€ ì“°ê¸°</button>
        </div>
        <div id="postList">
            <div style="text-align:center; padding: 2rem; color:#888;">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
        <div class="pagination" id="paginationControls">
            <button class="btn-page" onclick="changePage(-1)" id="btnPrev">ì´ì „</button>
            <span id="pageIndicator" style="display:flex; align-items:center; font-weight:bold; color:#555;">1</span>
            <button class="btn-page" onclick="changePage(1)" id="btnNext">ë‹¤ìŒ</button>
        </div>
    </main>

    <div id="loginModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('loginModal')">&times;</span>
            <h2 style="text-align:center; margin-bottom:20px;">ë¡œê·¸ì¸</h2>

            <input type="email" id="loginEmail" class="form-input" placeholder="ì´ë©”ì¼">
            <div id="loginEmailErrorMsg" class="error-msg">ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. (ì˜ˆ: user@example.com)</div>

            <input type="password" id="loginPassword" class="form-input" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <div id="loginPwErrorMsg" class="error-msg">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>

            <button class="btn-submit" onclick="login()">ë¡œê·¸ì¸í•˜ê¸°</button>

            <div style="margin-top: 15px; text-align: center; font-size: 0.9rem;">
                ì•„ì§ íšŒì›ì´ ì•„ë‹ˆì‹ ê°€ìš”?
                <span onclick="switchToSignup()" style="color: #007bff; cursor: pointer; font-weight: 500;">íšŒì›ê°€ì…í•˜ê¸°</span>
            </div>
        </div>
    </div>

    <div id="signupModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('signupModal')">&times;</span>
            <h2 style="text-align:center; margin-bottom:20px;">íšŒì›ê°€ì…</h2>

            <input type="email" id="signupEmail" class="form-input" placeholder="ì´ë©”ì¼">
            <div id="emailErrorMsg" class="error-msg">ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. (ì˜ˆ: user@example.com)</div>

            <input type="text" id="signupNickname" class="form-input" placeholder="ë‹‰ë„¤ì„ (10ì ì´ë‚´, ë„ì–´ì“°ê¸° ê¸ˆì§€)">

            <input type="password" id="signupPassword" class="form-input" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <div id="pwRuleErrorMsg" class="error-msg">ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒ, 20ì ì´í•˜ì´ë©°, ëŒ€ë¬¸ì, ì†Œë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ìë¥¼ ê°ê° ìµœì†Œ 1ê°œ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.</div>
            <div id="pwRuleSuccessMsg" class="success-msg">ì‚¬ìš© ê°€ëŠ¥í•œ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.</div>

            <input type="password" id="signupConfirm" class="form-input" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
            <div id="pwMatchErrorMsg" class="error-msg">ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>

            <button class="btn-submit" id="btnSignupSubmit" onclick="signup()" disabled>ê°€ì…í•˜ê¸°</button>
        </div>
    </div>

    <div id="profileModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('profileModal')">&times;</span>
            <div class="profile-edit-header">
                <img src="https://via.placeholder.com/100" id="profileImgPreview" class="profile-img-large" onclick="document.getElementById('profileImgInput').click()">
                <input type="file" id="profileImgInput" style="display:none;" accept="image/*" onchange="previewImage(this)">
                <div class="img-upload-hint">ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ì—¬ ë³€ê²½</div>
                <div id="displayEmail" class="profile-email"></div>
            </div>
            <label style="font-weight:bold;">ë‹‰ë„¤ì„</label>
            <input type="text" id="editNickname" class="form-input" placeholder="ë‹‰ë„¤ì„">

            <button class="btn-submit" onclick="updateProfile()">ì •ë³´ ìˆ˜ì • ì™„ë£Œ</button>
            <button class="btn-delete-account" onclick="deleteUser()">íšŒì› íƒˆí‡´</button>
        </div>
    </div>

    <div id="passwordModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('passwordModal')">&times;</span>
            <h2 style="text-align:center; margin-bottom:20px;">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h2>

            <input type="password" id="newPassword" class="form-input" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸">
            <div id="newPwRuleErrorMsg" class="error-msg">ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒ, 20ì ì´í•˜ì´ë©°, ëŒ€ë¬¸ì, ì†Œë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ìë¥¼ ê°ê° ìµœì†Œ 1ê°œ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.</div>
            <div id="newPwRuleSuccessMsg" class="success-msg">ì‚¬ìš© ê°€ëŠ¥í•œ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.</div>

            <input type="password" id="confirmPassword" class="form-input" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
            <div id="newPwMatchErrorMsg" class="error-msg">ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>

            <button class="btn-submit" id="btnUpdatePwSubmit" onclick="updatePassword()" disabled>ë³€ê²½í•˜ê¸°</button>
        </div>
    </div>

    <div id="writeModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('writeModal')">&times;</span>
            <h2 style="text-align:center; margin-bottom:15px;">ê²Œì‹œê¸€ ì‘ì„±</h2>
            <input type="text" id="postTitle" class="form-input" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
            <input type="text" id="postImage" class="form-input" placeholder="ì´ë¯¸ì§€ URL (ì„ íƒì‚¬í•­ - ì˜ˆ: https://example.com/image.jpg)">

            <div class="ai-toolbar">
                <span>ğŸ¤– AI í†¤ ë³€í™˜:</span>
                <select id="toneSelect" class="ai-select">
                    <option value="ì‚¬ê·¹">ì‚¬ê·¹</option>
                    <option value="ì¤‘2ë³‘">ì¤‘2ë³‘</option>
                    <option value="ì „ë¼ë„ ì‚¬íˆ¬ë¦¬">ì „ë¼ë„ ì‚¬íˆ¬ë¦¬</option>
                    <option value="ìœ ì¹˜ì›ìƒ">ìœ ì¹˜ì›ìƒ</option>
                </select>
                <button class="btn-ai" onclick="convertAI()">ë³€í™˜ ì ìš©</button>
            </div>

            <textarea id="postContent" class="form-textarea" placeholder="ë‚´ìš©ì„ ììœ ë¡­ê²Œ ì‘ì„±í•˜ì„¸ìš”"></textarea>
            <button class="btn-submit" onclick="createPost()">ë“±ë¡í•˜ê¸°</button>
        </div>
    </div>

    <div id="detailModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('detailModal')">&times;</span>
            <h2 id="dTitle" class="detail-title">ì œëª©</h2>
            <img id="dImage" class="detail-img" src="" alt="Post Image">
            <div class="detail-info">
                <span id="dAuthor" style="font-weight:bold;">ì‘ì„±ì</span>
                <span><span id="dDate">ë‚ ì§œ</span> <span id="dViews" style="margin-left:10px;">ì¡°íšŒìˆ˜ 0</span></span>
            </div>
            <div id="dContent" class="detail-body">ë‚´ìš©</div>
            <div class="detail-actions">
                <button class="btn-like" onclick="toggleLike()">â¤ï¸ ì¢‹ì•„ìš” <span id="dLikes">0</span></button>
                <button class="btn-logout" id="btnDeletePost" style="display:none;" onclick="deletePost()">ì‚­ì œ</button>
            </div>
            <div class="comment-section">
                <div class="comment-header-text">ëŒ“ê¸€</div>
                <div class="comment-input-box">
                    <input type="text" id="commentInput" class="comment-input" placeholder="ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”">
                    <button class="btn-comment" onclick="addComment()">ë“±ë¡</button>
                </div>
                <div id="commentList" class="comment-list"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "http://localhost:8000";
        const DEFAULT_PROFILE_IMG = "https://via.placeholder.com/40";
        const DEFAULT_LARGE_IMG = "https://via.placeholder.com/100";

        let userToken = localStorage.getItem("access_token");
        let userId = localStorage.getItem("user_id");
        let userEmail = localStorage.getItem("user_email");
        let userNickname = localStorage.getItem("user_nickname");
        let currentPostId = null;

        let currentPage = 1;
        const pageSize = 10;
        let hasMorePosts = true;

        document.addEventListener("DOMContentLoaded", () => {
            updateNav();
            loadPosts(1);
            setupSignupValidation();
            setupLoginValidation();
            setupPasswordValidation();

            document.addEventListener('click', function(event) {
                const profileContainer = document.querySelector('.profile-container');
                const dropdown = document.querySelector('.dropdown-menu');
                if (dropdown && profileContainer && !profileContainer.contains(event.target)) {
                    dropdown.classList.remove('show');
                }
            });
        });

        // --- íšŒì›ê°€ì… ê²€ì¦ ---
        function setupSignupValidation() {
            const emailInput = document.getElementById("signupEmail");
            const nickInput = document.getElementById("signupNickname");
            const pwInput = document.getElementById("signupPassword");
            const pwConfirm = document.getElementById("signupConfirm");
            const btnSubmit = document.getElementById("btnSignupSubmit");

            const emailError = document.getElementById("emailErrorMsg");
            const pwRuleError = document.getElementById("pwRuleErrorMsg");
            const pwRuleSuccess = document.getElementById("pwRuleSuccessMsg");
            const pwMatchError = document.getElementById("pwMatchErrorMsg");

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const pwRegex = /^(?=.*[A-Z])(?=.*[a-z])(?=.*\d)(?=.*\W).{8,20}$/;

            function validateForm() {
                const emailVal = emailInput.value;
                const nickVal = nickInput.value;
                const pwVal = pwInput.value;
                const confirmVal = pwConfirm.value;

                let isEmailValid = false, isNickValid = false, isPwValid = false, isMatchValid = false;

                if (emailVal) {
                    if (emailRegex.test(emailVal)) { isEmailValid = true; emailError.style.display = "none"; emailInput.style.borderColor = "#ddd"; }
                    else { emailError.style.display = "block"; emailInput.style.borderColor = "#dc3545"; }
                } else { emailError.style.display = "none"; emailInput.style.borderColor = "#ddd"; }

                if (nickVal && nickVal.trim().length > 0 && nickVal.indexOf(" ") === -1 && nickVal.length <= 10) isNickValid = true;

                if (pwVal) {
                    if (pwRegex.test(pwVal)) { isPwValid = true; pwRuleError.style.display = "none"; pwRuleSuccess.style.display = "block"; pwInput.style.borderColor = "#28a745"; }
                    else { pwRuleError.style.display = "block"; pwRuleSuccess.style.display = "none"; pwInput.style.borderColor = "#dc3545"; }
                } else { pwRuleError.style.display = "none"; pwRuleSuccess.style.display = "none"; pwInput.style.borderColor = "#ddd"; }

                if (confirmVal) {
                    if (pwVal === confirmVal) { isMatchValid = true; pwMatchError.style.display = "none"; pwConfirm.style.borderColor = "#ddd"; }
                    else { pwMatchError.style.display = "block"; pwConfirm.style.borderColor = "#dc3545"; }
                } else { pwMatchError.style.display = "none"; pwConfirm.style.borderColor = "#ddd"; }

                if (isEmailValid && isNickValid && isPwValid && isMatchValid) btnSubmit.disabled = false;
                else btnSubmit.disabled = true;
            }

            [emailInput, nickInput, pwInput, pwConfirm].forEach(inp => {
                inp.addEventListener("input", validateForm);
                inp.addEventListener("keydown", (e) => {
                    if (e.key === "Enter" && !btnSubmit.disabled) signup();
                });
            });
        }

        // --- ë¡œê·¸ì¸ ê²€ì¦ ---
        function setupLoginValidation() {
            const emailInput = document.getElementById("loginEmail");
            const pwInput = document.getElementById("loginPassword");
            const emailError = document.getElementById("loginEmailErrorMsg");
            const pwError = document.getElementById("loginPwErrorMsg");
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            emailInput.addEventListener("input", () => {
                const val = emailInput.value;
                if(val && !emailRegex.test(val)) {
                    emailError.style.display = "block";
                    emailInput.style.borderColor = "#dc3545";
                } else {
                    emailError.style.display = "none";
                    emailInput.style.borderColor = "#ddd";
                }
            });

            pwInput.addEventListener("input", () => {
                if(pwInput.value.trim()) {
                    pwError.style.display = "none";
                    pwInput.style.borderColor = "#ddd";
                }
            });

            [emailInput, pwInput].forEach(inp => {
                inp.addEventListener("keydown", (e) => {
                    if (e.key === "Enter") login();
                });
            });
        }

        // --- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ê²€ì¦ ---
        function setupPasswordValidation() {
            const pwInput = document.getElementById("newPassword");
            const pwConfirm = document.getElementById("confirmPassword");
            const btnSubmit = document.getElementById("btnUpdatePwSubmit");

            const pwRuleError = document.getElementById("newPwRuleErrorMsg");
            const pwRuleSuccess = document.getElementById("newPwRuleSuccessMsg");
            const pwMatchError = document.getElementById("newPwMatchErrorMsg");
            const pwRegex = /^(?=.*[A-Z])(?=.*[a-z])(?=.*\d)(?=.*\W).{8,20}$/;

            function validatePwForm() {
                const pwVal = pwInput.value;
                const confirmVal = pwConfirm.value;
                let isPwValid = false, isMatchValid = false;

                if (pwVal) {
                    if (pwRegex.test(pwVal)) {
                        isPwValid = true;
                        pwRuleError.style.display = "none";
                        pwRuleSuccess.style.display = "block";
                        pwInput.style.borderColor = "#28a745";
                    } else {
                        pwRuleError.style.display = "block";
                        pwRuleSuccess.style.display = "none";
                        pwInput.style.borderColor = "#dc3545";
                    }
                } else {
                    pwRuleError.style.display = "none";
                    pwRuleSuccess.style.display = "none";
                    pwInput.style.borderColor = "#ddd";
                }

                if (confirmVal) {
                    if (pwVal === confirmVal) {
                        isMatchValid = true;
                        pwMatchError.style.display = "none";
                        pwConfirm.style.borderColor = "#ddd";
                    } else {
                        pwMatchError.style.display = "block";
                        pwConfirm.style.borderColor = "#dc3545";
                    }
                } else {
                    pwMatchError.style.display = "none";
                    pwConfirm.style.borderColor = "#ddd";
                }

                if (isPwValid && isMatchValid) btnSubmit.disabled = false;
                else btnSubmit.disabled = true;
            }

            pwInput.addEventListener("input", validatePwForm);
            pwConfirm.addEventListener("input", validatePwForm);

            [pwInput, pwConfirm].forEach(inp => {
                inp.addEventListener("keydown", (e) => {
                    if (e.key === "Enter" && !btnSubmit.disabled) updatePassword();
                });
            });
        }

        function switchToSignup() {
            closeModal('loginModal');
            openModal('signupModal');
        }

        // --- ê³µí†µ UI ---
        function updateNav() {
            const nav = document.getElementById("navButtons");
            if (userToken) {
                let pImg = localStorage.getItem("user_image") || DEFAULT_PROFILE_IMG;
                if(pImg.startsWith("static")) pImg = API_BASE + "/" + pImg;
                nav.innerHTML = `
                    <div class="profile-container" onclick="toggleDropdown()">
                        <img src="${pImg}" class="profile-img-header" alt="Profile">
                        <div class="dropdown-menu" id="profileDropdown">
                            <div style="padding:12px 16px; color:#999; font-size:0.8rem;">${userEmail || 'ë¡œê·¸ì¸ ê³„ì •'}</div>
                            <hr class="dropdown-divider">
                            <button class="dropdown-item" onclick="openProfileModal()">íšŒì›ì •ë³´ ìˆ˜ì •</button>
                            <button class="dropdown-item" onclick="openModal('passwordModal')">ë¹„ë°€ë²ˆí˜¸ ìˆ˜ì •</button>
                            <hr class="dropdown-divider">
                            <button class="dropdown-item" style="color:red;" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                        </div>
                    </div>`;
            } else {
                nav.innerHTML = `<button class="btn-login" onclick="openModal('loginModal')">ë¡œê·¸ì¸</button><button class="btn-logout" onclick="openModal('signupModal')">íšŒì›ê°€ì…</button>`;
            }
        }
        function toggleDropdown() { document.getElementById("profileDropdown").classList.toggle("show"); }

        function openModal(id) {
            document.querySelectorAll('.modal-overlay').forEach(m => m.style.display='none');

            // íšŒì›ê°€ì… ì´ˆê¸°í™”
            if (id === 'signupModal') {
                document.getElementById("signupEmail").value = "";
                document.getElementById("signupNickname").value = "";
                document.getElementById("signupPassword").value = "";
                document.getElementById("signupConfirm").value = "";
                document.getElementById("emailErrorMsg").style.display = "none";
                document.getElementById("pwRuleErrorMsg").style.display = "none";
                document.getElementById("pwRuleSuccessMsg").style.display = "none";
                document.getElementById("pwMatchErrorMsg").style.display = "none";
                document.getElementById("signupEmail").style.borderColor = "#ddd";
                document.getElementById("signupPassword").style.borderColor = "#ddd";
                document.getElementById("signupConfirm").style.borderColor = "#ddd";
                document.getElementById("btnSignupSubmit").disabled = true;
            }

            // ë¡œê·¸ì¸ ì´ˆê¸°í™”
            if (id === 'loginModal') {
                document.getElementById("loginEmail").value = "";
                document.getElementById("loginPassword").value = "";
                document.getElementById("loginEmailErrorMsg").style.display = "none";
                document.getElementById("loginPwErrorMsg").style.display = "none";
                document.getElementById("loginEmail").style.borderColor = "#ddd";
                document.getElementById("loginPassword").style.borderColor = "#ddd";
            }

            // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì´ˆê¸°í™”
            if (id === 'passwordModal') {
                document.getElementById("newPassword").value = "";
                document.getElementById("confirmPassword").value = "";
                document.getElementById("newPwRuleErrorMsg").style.display = "none";
                document.getElementById("newPwRuleSuccessMsg").style.display = "none";
                document.getElementById("newPwMatchErrorMsg").style.display = "none";
                document.getElementById("newPassword").style.borderColor = "#ddd";
                document.getElementById("confirmPassword").style.borderColor = "#ddd";
                document.getElementById("btnUpdatePwSubmit").disabled = true;
            }

            document.getElementById(id).style.display = 'flex';
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function openProfileModal() {
            document.getElementById("displayEmail").innerText = userEmail || "";
            document.getElementById("editNickname").value = userNickname || "";
            let pImg = localStorage.getItem("user_image") || DEFAULT_LARGE_IMG;
            if(pImg.startsWith("static")) pImg = API_BASE + "/" + pImg;
            document.getElementById("profileImgPreview").src = pImg;
            document.getElementById("profileImgInput").value = "";
            openModal('profileModal');
        }
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) { document.getElementById('profileImgPreview').src = e.target.result; }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- ëª©ë¡ ì¡°íšŒ ---
        async function loadPosts(page) {
            currentPage = page;
            try {
                const res = await fetch(`${API_BASE}/posts?page=${page}&size=${pageSize}`);
                const data = await res.json();
                const posts = data.posts || [];
                const list = document.getElementById("postList");
                if(posts.length === 0) {
                    list.innerHTML = `<div style='text-align:center; padding:2rem;'>${page === 1 ? 'ì‘ì„±ëœ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.' : 'ë” ì´ìƒ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>`;
                    hasMorePosts = false;
                } else {
                    hasMorePosts = true;
                    list.innerHTML = posts.map(p => {
                        let thumbHtml = '';
                        if(p.image && (p.image.startsWith('http') || p.image.startsWith('/'))) thumbHtml = `<img src="${p.image}" class="post-thumbnail" style="display:block">`;
                        return `<div class="post-card" onclick="openDetail(${p.id})">${thumbHtml}<div class="post-title">${escapeHtml(p.title)}</div><div class="post-content">${escapeHtml(p.content)}</div><div class="post-meta"><div class="post-author"><span>ğŸ‘¤ ${p.author_nickname || 'ìµëª…'}</span></div><span>ğŸ‘€ ${p.views}</span><span>â¤ï¸ ${p.likes}</span><span>ğŸ’¬ ${p.comments_count || 0}</span><span>ğŸ“… ${new Date(p.created_at).toLocaleDateString()}</span></div></div>`;
                    }).join('');
                }
                updatePaginationButtons();
            } catch(e) { console.error(e); }
        }
        function changePage(delta) { const nextPage = currentPage + delta; if(nextPage < 1) return; loadPosts(nextPage); }
        function updatePaginationButtons() {
            document.getElementById("pageIndicator").innerText = currentPage;
            document.getElementById("btnPrev").disabled = (currentPage === 1);
            const list = document.getElementById("postList");
            const items = list.getElementsByClassName("post-card");
            if(!hasMorePosts && items.length === 0) document.getElementById("btnNext").disabled = true;
            else document.getElementById("btnNext").disabled = false;
        }

        // --- ìƒì„¸, ê¸€ì“°ê¸° ---
        async function openDetail(id) {
            currentPostId = id;
            try {
                const res = await fetch(`${API_BASE}/posts/${id}`);
                if(!res.ok) throw new Error();
                const post = await res.json();
                document.getElementById("dTitle").innerText = post.title;
                document.getElementById("dContent").innerText = post.content;
                document.getElementById("dAuthor").innerText = `ğŸ‘¤ ${post.author_nickname || 'ìµëª…'}`;
                document.getElementById("dDate").innerText = new Date(post.created_at).toLocaleString();
                document.getElementById("dViews").innerText = `ì¡°íšŒìˆ˜ ${post.views}`;
                document.getElementById("dLikes").innerText = post.likes;
                const imgEl = document.getElementById("dImage");
                if(post.image) { imgEl.src = post.image; imgEl.style.display = 'block'; } else { imgEl.style.display = 'none'; }
                const delBtn = document.getElementById("btnDeletePost");
                if (userToken && post.author_id == userId) delBtn.style.display = 'block'; else delBtn.style.display = 'none';
                loadComments(id);
                openModal("detailModal");
            } catch(e) { alert("ê¸€ ë¡œë“œ ì‹¤íŒ¨"); }
        }
        async function createPost() {
            const title = document.getElementById("postTitle").value;
            const content = document.getElementById("postContent").value;
            const image = document.getElementById("postImage").value;
            try {
                const res = await fetch(`${API_BASE}/posts`, { method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${userToken}` }, body: JSON.stringify({ title, content, image }) });
                if(res.ok) { alert("ë“±ë¡ ì™„ë£Œ!"); closeModal("writeModal"); document.getElementById("postTitle").value = ""; document.getElementById("postContent").value = ""; document.getElementById("postImage").value = ""; loadPosts(1); }
            } catch(e) { alert("ì˜¤ë¥˜"); }
        }
        async function updateProfile() {
            const nickname = document.getElementById("editNickname").value;
            const fileInput = document.getElementById("profileImgInput");
            if(!nickname) return alert("ë‹‰ë„¤ì„ ì…ë ¥ í•„ìš”");
            const formData = new FormData();
            formData.append("nickname", nickname);
            if (fileInput.files[0]) formData.append("profile_image", fileInput.files[0]);
            try {
                // [ìˆ˜ì •ë¨] í—¤ë”ì— Content-Type ì œê±° (FormData ìë™ ì„¤ì •)
                const res = await fetch(`${API_BASE}/users/${userId}/profile`, { method: "PUT", headers: { "Authorization": `Bearer ${userToken}` }, body: formData });
                if(res.ok) { const data = await res.json(); localStorage.setItem("user_nickname", data.updated_nickname); if(data.updated_image) localStorage.setItem("user_image", data.updated_image); userNickname = data.updated_nickname; alert("ìˆ˜ì • ì™„ë£Œ"); closeModal("profileModal"); updateNav(); }
                else { const err = await res.json(); alert(err.detail || "ì‹¤íŒ¨"); }
            } catch(e) { alert("ì˜¤ë¥˜"); }
        }

        async function updatePassword() {
            const password = document.getElementById("newPassword").value;
            const confirm = document.getElementById("confirmPassword").value;
            if(!password || !confirm) return;

            try {
                const res = await fetch(`${API_BASE}/users/${userId}/password`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${userToken}` },
                    body: JSON.stringify({ password, confirm_password: confirm })
                });
                if(res.ok) {
                    alert("ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    closeModal("passwordModal");
                } else {
                    const err = await res.json();
                    alert(err.detail || "ë³€ê²½ ì‹¤íŒ¨");
                }
            } catch(e) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
        }

        // --- ê¸°íƒ€ ê¸°ëŠ¥ ---
        async function toggleLike() {
            if(!userToken) return alert("ë¡œê·¸ì¸ í•„ìš”");
            try { const res = await fetch(`${API_BASE}/posts/${currentPostId}/like`, { method: "POST", headers: { "Authorization": `Bearer ${userToken}` } }); if(res.ok) { const data = await res.json(); document.getElementById("dLikes").innerText = data.likes; } } catch(e) {}
        }
        async function deleteUser() {
            if(!confirm("ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ì •ë³´ê°€ ì‚­ì œë©ë‹ˆë‹¤.")) return;
            try {
                const res = await fetch(`${API_BASE}/users/${userId}`, {
                    method: "DELETE",
                    headers: { "Authorization": `Bearer ${userToken}` }
                });
                if(res.ok) {
                    alert("íšŒì› íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    logout();
                } else alert("íƒˆí‡´ ì‹¤íŒ¨");
            } catch(e) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
        }
        async function deletePost() {
            if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            try { const res = await fetch(`${API_BASE}/posts/${currentPostId}`, { method: "DELETE", headers: { "Authorization": `Bearer ${userToken}` } }); if(res.ok) { alert("ì‚­ì œë¨"); closeModal("detailModal"); loadPosts(currentPage); } } catch(e) {}
        }
        async function loadComments(postId) {
            try { const res = await fetch(`${API_BASE}/comments/${postId}`); const comments = await res.json(); const list = document.getElementById("commentList"); if (comments.length === 0) { list.innerHTML = "<div style='color:#aaa; text-align:center;'>ëŒ“ê¸€ ì—†ìŒ</div>"; return; } list.innerHTML = comments.map(c => `<div class="comment-item"><div class="comment-header"><span>ğŸ‘¤ ${c.author_nickname}</span> ${userToken ? `<span class="btn-del-comment" onclick="deleteComment(${c.id})">ì‚­ì œ</span>` : ''}</div><div class="comment-body">${escapeHtml(c.content)}</div></div>`).join(''); } catch(e) {}
        }
        async function addComment() {
            const content = document.getElementById("commentInput").value; if(!content) return;
            try { await fetch(`${API_BASE}/comments/${currentPostId}`, { method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${userToken}` }, body: JSON.stringify({ content }) }); document.getElementById("commentInput").value = ""; loadComments(currentPostId); } catch(e) {}
        }
        async function deleteComment(cid) {
            if(confirm("ì‚­ì œ?")) await fetch(`${API_BASE}/comments/${cid}`, { method: "DELETE", headers: { "Authorization": `Bearer ${userToken}` } }); loadComments(currentPostId);
        }
        async function convertAI() {
            const text = document.getElementById("postContent").value; const tone = document.getElementById("toneSelect").value; if(!text) return alert("ë‚´ìš© ì…ë ¥ í•„ìš”");
            try { const res = await fetch(`${API_BASE}/ai_tone/convert`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ text, tone }) }); const data = await res.json(); if(data.converted_text) document.getElementById("postContent").value = data.converted_text; } catch(e) {}
        }

        async function login() {
            const emailInput = document.getElementById("loginEmail");
            const pwInput = document.getElementById("loginPassword");
            const email = emailInput.value;
            const password = pwInput.value;

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            let isValid = true;

            if(!email || !emailRegex.test(email)) {
                document.getElementById("loginEmailErrorMsg").style.display = "block";
                emailInput.style.borderColor = "#dc3545";
                isValid = false;
            }
            if(!password) {
                document.getElementById("loginPwErrorMsg").style.display = "block";
                pwInput.style.borderColor = "#dc3545";
                isValid = false;
            }
            if(!isValid) return;

            try { const res = await fetch(`${API_BASE}/auth/login`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ email, password }) }); if(res.ok) { const data = await res.json(); localStorage.setItem("access_token", data.access_token); localStorage.setItem("user_id", data.user_id); localStorage.setItem("user_email", email); userToken = data.access_token; userId = data.user_id; userEmail = email; updateNav(); closeModal("loginModal"); } else alert("ë¡œê·¸ì¸ ì‹¤íŒ¨"); } catch(e) {}
        }

        async function signup() {
            const email = document.getElementById("signupEmail").value;
            const nickname = document.getElementById("signupNickname").value;
            const password = document.getElementById("signupPassword").value;
            const confirm = document.getElementById("signupConfirm").value;

            if (!email || !nickname || !password || !confirm) return;

            try {
                const res = await fetch(`${API_BASE}/auth/signup`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ email, nickname, password, password_confirm: confirm }) });
                if(res.ok) { alert("ê°€ì… ì™„ë£Œ"); closeModal("signupModal"); }
                else { const err = await res.json(); alert(err.detail || "ê°€ì… ì‹¤íŒ¨"); }
            } catch(e) { alert("ì˜¤ë¥˜"); }
        }
        function logout() { localStorage.clear(); userToken=null; updateNav(); alert("ë¡œê·¸ì•„ì›ƒ"); location.reload(); }
        function openWriteModal() { if(!userToken) return alert("ë¡œê·¸ì¸ í•„ìš”"); openModal("writeModal"); }
        function escapeHtml(text) { return text ? text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : ""; }
    </script>
</body>
</html>